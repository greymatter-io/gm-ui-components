# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#

# Set defaults for all jobs
defaults: &defaults
  working_directory: ~/repo
  environment:
    CC_TEST_REPORTER_ID: c54354c67485869b121e5dcdb231ceefcbe890a99864521430f328118fb9fa4d
  docker:
    - image: circleci/node:carbon

version: 2
jobs:
  setup:
    <<: *defaults
    steps:
      - checkout
      # Download and cache dependencies
      - restore_cache:
          name: Restore node_modules and CC test reporter
          keys:
          - cache-{{ .Branch }}-{{ checksum "package.json" }}
          # fallback to using the latest cache if no exact match is found
          - cache-{{ .Branch }}-
          - cache-
      - run:
          name: Install dependencies
          command: |
            npm install
      - run:
          name: Install Code Climate Test Reporter
          command: |
            if [ ! -f cc-test-reporter ]; then curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter && chmod +x ./cc-test-reporter; fi
      - save_cache:
          name: Cache node_modules and Code Climate Test Reporter
          paths:
            - node_modules
            - cc-test-reporter
          key: cache-{{ .Branch }}-{{ checksum "package.json" }}

  build:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          name: Restore node_modules
          keys:
          - cache-{{ .Branch }}-{{ checksum "package.json" }}
          # fallback to using the latest cache if no exact match is found
          - cache-{{ .Branch }}-
          - cache-
      # Generate a build
      - run:
          name: Build the application
          command: |
            npm run build
      - run:
          name: Compress the build directory into a tarball
          command: |
            tar -czf lib.tar.gz lib
      # Store Assets generated by npm build
      - store_artifacts:
          path: lib.tar.gz

  # run tests!
  test:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          name: Restore node_modules and Code Climate Test Reporter
          keys:
          - cache-{{ .Branch }}-{{ checksum "package.json" }}
          # fallback to using the latest cache if no exact match is found
          - cache-{{ .Branch }}
          - cache-
      # CircleCI 2.0 no longer allows interpolation of env variables. This is the workaround: 
      # https://discuss.circleci.com/t/using-environment-variables-in-config-yml-not-working/14237
      - run:
          name: Prepare Code Climate Test Reporter
          command: |
            ./cc-test-reporter before-build
      - run:
          name: Run tests
          # split tests by timing and then run npm test
          command: |
            JEST_JUNIT_OUTPUT="junit.xml" npm test -- --testResultsProcessor="jest-junit"  --coverage --ci
      # Note: When re-running a build in CircleCI, Code Climate returns a
      # failure state with the error message:
      #
      # Error: response from https://api.codeclimate.com/v1/test_reports.
      # HTTP 409: A test report for commit f4014287c1624ae09d9008a78bd6f343912b976d
      # already exists
      #
      # This causes the CircleCI build to fail. As a workaround, I have
      # appended `|| true` to the end of the command, which resolves
      # the issue but also silences all error reporting for the Test Reporter
      #
      # https://github.com/codeclimate/test-reporter/issues/192
      - run: 
          name: Format coverage & Send Istanbul LCOV Results to Code Climate
          command: |
             ./cc-test-reporter after-build
      # Store Assets generated by npm test
      - store_artifacts:
          path: junit
      - store_test_results:
          path: junit
      - store_artifacts:
          path: coverage

# Define a workflow to specify the run order of jobs
# More info at https://circleci.com/docs/2.0/workflows/
workflows:
  version: 2
  build_and_test:
    jobs:
      - setup
      - test:
          requires:
            - setup
      - build:
          requires: 
            - setup